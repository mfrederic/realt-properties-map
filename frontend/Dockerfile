ARG NODE_IMAGE=node:21-alpine
ARG REACT_APP_REALT_PROPERTIES_BACKEND_URL
ARG REACT_APP_REALT_THEGRAPH_URL=https://gateway-arbitrum.network.thegraph.com/api/
ARG REACT_APP_REALT_THEGRAPH_API_KEY
ARG REACT_APP_REALT_THEGRAPH_GNOSIS=subgraphs/id/FPPoFB7S2dcCNrRyjM5QbaMwKqRZPdbTg8ysBrwXd4SP
ARG REACT_APP_REALT_THEGRAPH_RMM=rsubgraphs/id/9Ut97U2oMKwRucppj7fdMeZ8oFCJrUYyr8wu4hFXBn7Y
ARG REACT_APP_REALT_THEGRAPH_ETH=subgraphs/id/EVjGN4mMd9h9JfGR7yLC6T2xrJf9syhjQNboFb7GzxVW

FROM $NODE_IMAGE AS dependencies
WORKDIR /app
COPY ./package*.json ./
RUN npm ci
COPY . .

FROM dependencies as build
ENV NODE_ENV=production
ENV REACT_APP_REALT_PROPERTIES_BACKEND_URL=$REACT_APP_REALT_PROPERTIES_BACKEND_URL
ENV REACT_APP_REALT_THEGRAPH_URL=$REACT_APP_REALT_THEGRAPH_URL
ENV REACT_APP_REALT_THEGRAPH_API_KEY=$REACT_APP_REALT_THEGRAPH_API_KEY
ENV REACT_APP_REALT_THEGRAPH_GNOSIS=$REACT_APP_REALT_THEGRAPH_GNOSIS
ENV REACT_APP_REALT_THEGRAPH_RMM=$REACT_APP_REALT_THEGRAPH_RMM
ENV REACT_APP_REALT_THEGRAPH_ETH=$REACT_APP_REALT_THEGRAPH_ETH
ENV GENERATE_SOURCEMAP=false
RUN npm run build

FROM nginx:1.25.4-alpine as serve
ENV NODE_ENV production
RUN apk update && apk add bash nodejs npm
COPY --from=build /app/build /usr/share/nginx/html
COPY nginx/nginx.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/nginx/*.sh /usr/share/nginx/

CMD ["bash", "/usr/share/nginx/start.sh"]